<!-- Wrapper -->
<div class="container-fluid h-100 d-flex flex-column bg-light">
  <!-- Header -->
  <div
    class="d-flex justify-content-between align-items-center p-3 border-bottom bg-white shadow-sm"
  >
    <div class="d-flex align-items-center">
      <img src="https://placehold.co/40x40/2A4A7C/FFFFFF?text=C" class="rounded-circle" />
      <h1 class="fs-5 fw-bold ms-3 d-none d-sm-block">RealSpark</h1>
    </div>
    <div class="d-flex align-items-center" *ngIf="userDetails">
      <div class="dropdown">
        <button
          class="btn btn-link d-flex align-items-center text-decoration-none dropdown-toggle border-0 p-0"
          type="button"
          id="clientChatDropdownMenuButton"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          (click)="toggleDropdown($event)"
        >
          <div class="text-end me-3">
            <p class="fw-semibold mb-0">{{ userDetails.name }}</p>
            <p class="text-primary fw-bold small mb-0">Tokens: {{ userDetails.credits_balance }}</p>
          </div>
          <p-avatar
            [image]="userDetails.profile_photo"
            shape="circle"
            class="mr-2"
            size="large"
          ></p-avatar>
        </button>
        <!-- Dropdown menu -->
        <ul class="dropdown-menu dropdown-menu-end shadow" 
            [class.show]="isDropdownOpen"
            aria-labelledby="clientChatDropdownMenuButton">
          <li>
            <button
              type="button"
              class="btn btn-sm dropdown-item d-flex align-items-center"
              (click)="navigateToAccount(); closeDropdown()"
            >
              <i class="pi pi-user-edit me-2"></i>
              Account Settings
            </button>
          </li>
          <li>
            <button
              type="button"
              class="btn btn-sm dropdown-item d-flex align-items-center"
              (click)="navigateToBuyCredit(); closeDropdown()"
            >
              <i class="pi pi-wallet me-2"></i>
              Buy Tokens
            </button>
          </li>
          <li><hr class="dropdown-divider" /></li>
          <li>
            <button 
              type="button"
              class="dropdown-item d-flex align-items-center text-danger border-0 bg-transparent w-100 text-start" 
              (click)="logout(); closeDropdown()"
            >
              <i class="pi pi-sign-out me-2"></i>
              Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Chat Box -->
  <div
    class="flex-grow-1 d-flex flex-column shadow bg-white mt-3 rounded overflow-hidden mx-auto w-100"
    style="max-width: 700px"
  >
    <!-- Chat Header -->
    <div
      class="d-flex justify-content-between align-items-center p-3 border-bottom bg-white"
      *ngIf="writerProfile"
    >
      <div class="d-flex align-items-center">
        <i class="pi pi-arrow-left text-primary fs-4" (click)="navigateToClientHome()"></i>
        <img
          src="https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=100&q=80"
          width="48"
          class="rounded-circle border border-success ms-3"
        />
        <div class="ms-3">
          <h2 class="fs-6 fw-bold mb-0">
            {{ writerProfile.name }}
          </h2>
          <span class="text-success small fw-semibold">{{ writerProfile.last_seen_at }}</span>
        </div>
      </div>
      <p-menu #menu [model]="items" [popup]="true" />
      <p-button (click)="menu.toggle($event)" icon="pi pi-ellipsis-v" />
    </div>
    <!-- start of report user modal -->
    <p-dialog
      header="Report chat"
      [modal]="true"
      [(visible)]="visible"
      [style]="{ width: '25rem' }"
    >
      <div class="flex items-center gap-4 mb-4">
        <form [formGroup]="reportForm">
          <div class="form-group">
            <label for="reason" class="form-label">Reason</label>
            <input type="text" class="form-control" id="reason" formControlName="reason" />
          </div>
          <div class="form-group mt-2">
            <label for="description" class="form-label">Description</label>
            <textarea
              id="description"
              class="form-control"
              cols="5"
              rows="3"
              formControlName="description"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-outline-secondary" (click)="visible = false">Cancel</button>
        <button class="btn btn-primary" 
                [disabled]="reportForm.invalid"
                (click)="reportUser()">Report</button>
      </div>
    </p-dialog>
    <!-- Messages -->
    <div
      id="messageArea"
      class="flex-grow-1 p-3 overflow-auto bg-light"
      *ngIf="writerProfile && userDetails"
    >
      <p class="text-center text-muted small">Today</p>

      <ng-container *ngFor="let msg of messages">
        <!-- Incoming messages from the writer -->
        <!-- The sender_type is 'profile' or 'writer'  -->
        <div class="d-flex mb-3" *ngIf="msg.sender_id === writerProfile.id">
          <div class="bg-secondary p-3 rounded shadow-sm" style="max-width: 60%">
            <!-- Message content -->
            <p class="mb-1" style="word-wrap: break-word" *ngIf="msg?.message">{{ msg?.message }}</p>
            
            <!-- Attachments -->
            <div *ngIf="msg.attachments && msg.attachments.length > 0" class="mt-2">
              <div *ngFor="let attachment of msg.attachments" class="mb-2">
                <div *ngIf="attachment.type === 'image'">
                  <img [src]="'data:' + attachment.mimeType + ';base64,' + attachment.data" 
                       [alt]="attachment.filename" 
                       class="img-fluid rounded"
                       style="max-width: 200px; cursor: pointer;"
                       (click)="openImageModal('data:' + attachment.mimeType + ';base64,' + attachment.data)">
                </div>
                <div *ngIf="attachment.type === 'file'" class="d-flex align-items-center">
                  <i class="pi pi-file me-2"></i>
                  <span class="small">{{ attachment.filename }} ({{ getFileSize(attachment.size) }})</span>
                </div>
              </div>
            </div>
            
            <!-- Timestamp -->
            <span class="text-muted small">{{ msg.created_at | date : 'shortTime' }}</span>
          </div>
        </div>

        <!-- Outgoing (Message from the Client)-->
        <!-- The sender_id is the logged-in client's ID  -->
        <div class="d-flex justify-content-end mb-3" *ngIf="msg.sender_id === userDetails.id">
          <div class="text-white p-3 rounded bg-primary shadow-sm" style="max-width: 60%">
            <!-- Message content -->
            <p class="mb-1" style="word-wrap: break-word" *ngIf="msg.content">{{ msg.content }}</p>
            
            <!-- Attachments -->
            <div *ngIf="msg.attachments && msg.attachments.length > 0" class="mt-2">
              <div *ngFor="let attachment of msg.attachments" class="mb-2">
                <div *ngIf="attachment.type === 'image'">
                  <img [src]="'data:' + attachment.mimeType + ';base64,' + attachment.data" 
                       [alt]="attachment.filename" 
                       class="img-fluid rounded"
                       style="max-width: 200px; cursor: pointer;"
                       (click)="openImageModal('data:' + attachment.mimeType + ';base64,' + attachment.data)">
                </div>
                <div *ngIf="attachment.type === 'file'" class="d-flex align-items-center text-white">
                  <i class="pi pi-file me-2"></i>
                  <span class="small">{{ attachment.filename }} ({{ getFileSize(attachment.size) }})</span>
                </div>
              </div>
            </div>
            
            <!-- Timestamp -->
            <span class="small opacity-75">{{ msg.created_at | date : 'shortTime' }}</span>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Input -->
    <div class="p-3 border-top bg-white">
      <!-- Selected Files Preview (before processing) -->
      <div *ngIf="selectedFiles.length > 0" class="mb-3">
        <h6 class="small text-muted mb-2">Selected Files:</h6>
        <div class="d-flex flex-wrap gap-2">
          <div *ngFor="let file of selectedFiles; let i = index" 
               class="position-relative border rounded p-2 bg-light">
            <div class="d-flex align-items-center">
              <img *ngIf="filePreviewUrls[file.name]" 
                   [src]="filePreviewUrls[file.name]" 
                   alt="Preview" 
                   class="rounded me-2" 
                   style="width: 40px; height: 40px; object-fit: cover;">
              <i *ngIf="!filePreviewUrls[file.name]" class="pi pi-file me-2"></i>
              <div>
                <div class="small fw-semibold">{{ file.name }}</div>
                <div class="small text-muted">{{ getFileSize(file.size) }}</div>
              </div>
            </div>
            <button type="button" 
                    class="btn-close position-absolute top-0 end-0" 
                    (click)="removeSelectedFile(i)" 
                    style="font-size: 0.7rem;"></button>
          </div>
        </div>
        <div class="mt-2">
          <button class="btn btn-sm btn-primary me-2" 
                  [disabled]="isProcessingFiles"
                  (click)="processFiles()">
            <i class="pi pi-check me-1"></i>
            {{ isProcessingFiles ? 'Processing...' : 'Process Files' }}
          </button>
          <button class="btn btn-sm btn-info me-2" 
                  (click)="debugAttachments()">
            <i class="pi pi-info-circle me-1"></i>
            Debug
          </button>
          <button class="btn btn-sm btn-warning" 
                  (click)="testSendWithAttachment()">
            <i class="pi pi-send me-1"></i>
            Test Send
          </button>
        </div>
      </div>

      <!-- Processed Attachments Preview (ready to send) -->
      <div *ngIf="attachments.length > 0" class="mb-3">
        <h6 class="small text-muted mb-2">Ready to Send:</h6>
        <div class="d-flex flex-wrap gap-2">
          <div *ngFor="let attachment of attachments; let i = index" 
               class="position-relative border rounded p-2 bg-success bg-opacity-10">
            <div class="d-flex align-items-center">
              <i class="pi pi-check-circle text-success me-2"></i>
              <div>
                <div class="small fw-semibold">{{ attachment.filename }}</div>
                <div class="small text-muted">{{ getFileSize(attachment.size) }}</div>
              </div>
            </div>
            <button type="button" 
                    class="btn-close position-absolute top-0 end-0" 
                    (click)="removeAttachment(i)" 
                    style="font-size: 0.7rem;"></button>
          </div>
        </div>
      </div>

      <div class="input-group align-items-stretch">
        <!-- File Upload Button -->
        <label class="btn btn-outline-secondary d-flex align-items-center justify-content-center" 
               style="cursor: pointer;">
          <i class="pi pi-paperclip"></i>
          <input type="file" 
                 multiple 
                 accept="image/*,.pdf,.txt,.doc,.docx" 
                 (change)="onFileSelected($event)"
                 style="display: none;">
        </label>

        <textarea
          [(ngModel)]="chatInput"
          rows="1"
          class="form-control"
          placeholder="Type your message..."
          (keydown.enter)="sendMessage(); $event.preventDefault()"
        ></textarea>

        <button
          class="btn btn-primary d-flex align-items-center justify-content-center"
          [disabled]="(!chatInput.trim() && attachments.length === 0) || isSending"
          (click)="sendMessage()"
        >
          <i class="pi pi-send"></i>
        </button>
      </div>
    </div>
  </div>
</div>
